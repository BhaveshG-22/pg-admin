generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String       @id @default(cuid())
  clerkId             String       @unique
  email               String       @unique
  name                String
  avatar              String?
  credits             Int          @default(0)
  totalCreditsUsed    Int          @default(0)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  tier                UserTier     @default(FREE)
  subscriptionEndsAt  DateTime?
  subscriptionStatus  String?
  polarCustomerId     String?
  polarSubscriptionId String?      @unique
  generations         Generation[]
  images              UserImage[]

  @@map("users")
}

model Preset {
  id           String              @id @default(cuid())
  title        String
  description  String
  slug         String              @unique
  prompt       String
  badge        String
  badgeColor   String
  credits      Int
  category     String
  isActive     Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  inputFields  Json?
  owner        String?
  provider     Provider            @default(NANO_BANANA)
  thumbnailUrl String?
  variables    Json?
  slider_img   Json?
  gallery      Json?
  generations  Generation[]
  modelUsage   PresetModelUsage[]
  galleryJobs  GalleryJob[]

  @@map("presets")
}

model UserImage {
  id               String       @id @default(cuid())
  userId           String
  fileName         String
  originalFileName String
  fileSize         Int
  mimeType         String
  url              String
  thumbnailUrl     String
  width            Int
  height           Int
  uploadedAt       DateTime     @default(now())
  generations      Generation[]
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_images")
}

model Generation {
  id             String             @id @default(cuid())
  userId         String
  presetId       String
  userImageId    String?
  aspectRatio    AspectRatio?
  outputSize     OutputSize
  isPrivate      Boolean            @default(false)
  hasWatermark   Boolean            @default(true)
  inputValues    Json
  finalPrompt    String?
  status         GenerationStatus   @default(PENDING)
  creditsUsed    Int
  processingTime Int?
  createdAt      DateTime           @default(now())
  completedAt    DateTime?
  errorMessage   String?
  idempotencyKey String?            @unique
  outputUrl      String?
  updatedAt      DateTime           @updatedAt
  results        GenerationResult[]
  preset         Preset             @relation(fields: [presetId], references: [id])
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  originalImage  UserImage?         @relation(fields: [userImageId], references: [id])

  @@map("generations")
}

model GenerationResult {
  id             String     @id @default(cuid())
  generationId   String
  url            String
  thumbnailUrl   String
  width          Int
  height         Int
  fileSize       Int
  processingTime Int
  createdAt      DateTime   @default(now())
  generation     Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@map("generation_results")
}

model GlobalModel {
  id        String   @id @default(cuid())
  name      String
  imageUrl  String
  gender    Gender
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("global_models")
}

model PresetModelUsage {
  id       String   @id @default(cuid())
  presetId String
  modelId  String // Model ID from models.json (e.g., "male_01", "female_05")
  usedAt   DateTime @default(now())
  preset   Preset   @relation(fields: [presetId], references: [id], onDelete: Cascade)

  @@unique([presetId, modelId])
  @@map("preset_model_usage")
}

model GalleryJob {
  id        String           @id @default(cuid())
  presetId  String
  modelId   String // Model ID from models.json (e.g., "male_01", "female_05")
  variables Json?
  status    GalleryJobStatus @default(PENDING)
  imageUrl  String?
  error     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  preset    Preset           @relation(fields: [presetId], references: [id], onDelete: Cascade)

  @@map("gallery_jobs")
}

enum Gender {
  MALE
  FEMALE
}

enum AspectRatio {
  SQUARE
  PORTRAIT
  VERTICAL
  LANDSCAPE
  STANDARD
}

enum OutputSize {
  SQUARE
  PORTRAIT
  VERTICAL
  LANDSCAPE
  STANDARD
}

enum GenerationStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum UserTier {
  FREE
  PRO
  CREATOR
}

enum Provider {
  OPENAI
  FLUX_DEV
  FLUX_PRO
  FLUX_SCHNELL
  REPLICATE_OPENAI
  SEEDREAM
  STABLE_DIFFUSION
  FLUX_KONTEXT
  NANO_BANANA
}

enum GalleryJobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}
